{% extends "superadmin/base.html" %}

{% block title %}Manage Treatments & Taxes{% endblock %}

{% block content %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Bootstrap JS Bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- jsPDF for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Manage Treatments & Taxes</h1>
            
            <!-- Tabs -->
            <ul class="nav nav-tabs mb-4" id="managementTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="treatments-tab" data-bs-toggle="tab" data-bs-target="#treatments-content" type="button" role="tab" aria-controls="treatments-content" aria-selected="true">Treatment Prices</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="taxes-tab" data-bs-toggle="tab" data-bs-target="#taxes-content" type="button" role="tab" aria-controls="taxes-content" aria-selected="false">Tax Rates</button>
                </li>
                <!-- <li class="nav-item" role="presentation">
                    <button class="nav-link" id="hospital-tab" data-bs-toggle="tab" data-bs-target="#hospital-content" type="button" role="tab" aria-controls="hospital-content" aria-selected="false">Hospital Info</button>
                </li> -->
                <li class="nav-item" role="presentation">
                    <a href="/superadmin/hospital-info/" class="nav-link"  data-bs-target="#hospital-content" role="tab" aria-controls="hospital-content" aria-selected="false">
                        Hospital Info
                    </a>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="managementTabsContent">
                <!-- Treatments Tab -->
                <div class="tab-pane fade show active" id="treatments-content" role="tabpanel" aria-labelledby="treatments-tab">
                    <!-- Add New Treatment Price Form -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Add New Treatment Price</h5>
                        </div>
                        <div class="card-body">
                            <form id="treatmentPriceForm" method="post">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="treatment_name" class="form-label">Treatment Name</label>
                                        <input type="text" class="form-control" id="treatment_name" name="treatment_name" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="base_price" class="form-label">Base Price</label>
                                        <input type="number" step="0.01" class="form-control" id="base_price" name="base_price" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="tax_rate" class="form-label">Tax Rate</label>
                                    <select class="form-select" id="tax_rate" name="tax_rate">
                                        {% for tax_rate in tax_rates %}
                                        <option value="{{ tax_rate.id }}">CGST: {{ tax_rate.cgst }}% + SGST: {{ tax_rate.sgst }}% (Total: {{ tax_rate.cgst|add:tax_rate.sgst }}%)</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Treatment Price</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Treatment Prices List -->
                    <div class="card">
                        <div class="card-header">
                            <h5>Treatment Prices</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Treatment Name</th>
                                            <th>Base Price</th>
                                            <th>Total Price</th>
                                            <th>Last Updated</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for treatment in treatments %}
                                        <tr>
                                            <td>{{ treatment.id }}</td>
                                            <td>{{ treatment.treatment_name }}</td>
                                            <td>‚Çπ{{ treatment.base_price }}</td>
                                            <td>‚Çπ{{ treatment.total_price }}</td>
                                            <td>{{ treatment.updated_at|date:"d M Y" }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary edit-treatment-btn" data-id="{{ treatment.id }}">Edit</button>
                                                <button class="btn btn-sm btn-danger delete-treatment-btn" data-id="{{ treatment.id }}">Delete</button>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center">No treatment prices available</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tax Rates Tab -->
                <div class="tab-pane fade" id="taxes-content" role="tabpanel" aria-labelledby="taxes-tab">
                    <!-- Add New Tax Rate Form -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Add New Tax Rate</h5>
                        </div>
                        <div class="card-body">
                            <form id="taxRateForm" method="post">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="cgst" class="form-label">CGST (%)</label>
                                        <input type="number" step="0.01" class="form-control" id="cgst" name="cgst" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="sgst" class="form-label">SGST (%)</label>
                                        <input type="number" step="0.01" class="form-control" id="sgst" name="sgst" required>
                                    </div>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                                    <label class="form-check-label" for="is_active">
                                        Active
                                    </label>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Tax Rate</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Tax Rates List -->
                    <div class="card">
                        <div class="card-header">
                            <h5>Tax Rates</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>CGST (%)</th>
                                            <th>SGST (%)</th>
                                            <th>Total Tax (%)</th>
                                            <th>Status</th>
                                            <th>Last Updated</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for tax in tax_rates %}
                                        <tr>
                                            <td>{{ tax.id }}</td>
                                            <td>{{ tax.cgst }}%</td>
                                            <td>{{ tax.sgst }}%</td>
                                            <td>{{ tax.cgst|add:tax.sgst }}%</td>
                                            <td>
                                                {% if tax.is_active %}
                                                <span class="badge bg-success">Active</span>
                                                {% else %}
                                                <span class="badge bg-secondary">Inactive</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ tax.updated_at|date:"d M Y" }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary edit-tax-btn" data-id="{{ tax.id }}">Edit</button>
                                                <button class="btn btn-sm btn-danger delete-tax-btn" data-id="{{ tax.id }}">Delete</button>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center">No tax rates available</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hospital Info Tab - Fixed position (moved outside of taxes-content) -->
                <div class="tab-pane fade" id="hospital-content" role="tabpanel" aria-labelledby="hospital-tab">
                    <!-- Hospital List -->
                    <div class="card">
                        <div class="card-header">
                            <h5>Hospitals</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Email</th>
                                            <th>Established</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for hospital in hospitals %}
                                        <tr>
                                            <td>{{ hospital.id }}</td>
                                            <td>{{ hospital.name }}</td>
                                            <td>{{ hospital.phone }}</td>
                                            <td>{{ hospital.email }}</td>
                                            <td>{{ hospital.established_year }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-info view-hospital-btn" data-id="{{ hospital.id }}">View</button>
                                                <button class="btn btn-sm btn-primary edit-hospital-btn" data-id="{{ hospital.id }}">Edit</button>
                                                <button class="btn btn-sm btn-danger delete-hospital-btn" data-id="{{ hospital.id }}">Delete</button>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center">No hospitals available</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Treatment Modal -->
<div class="modal fade" id="editTreatmentModal" tabindex="-1" aria-labelledby="editTreatmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTreatmentModalLabel">Edit Treatment Price</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTreatmentForm">
                    <input type="hidden" id="edit_treatment_id">
                    <div class="mb-3">
                        <label for="edit_treatment_name" class="form-label">Treatment Name</label>
                        <input type="text" class="form-control" id="edit_treatment_name" name="treatment_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_base_price" class="form-label">Base Price</label>
                        <input type="number" step="0.01" class="form-control" id="edit_base_price" name="base_price" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_tax_rate" class="form-label">Tax Rate</label>
                        <select class="form-select" id="edit_tax_rate" name="tax_rate">
                            <!-- Tax rates will be loaded via AJAX -->
                            <option value="">Loading tax rates...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="updateTreatmentBtn">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Treatment Confirmation Modal -->
<div class="modal fade" id="deleteTreatmentModal" tabindex="-1" aria-labelledby="deleteTreatmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTreatmentModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this treatment price? This action cannot be undone.</p>
                <input type="hidden" id="delete_treatment_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteTreatmentBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Tax Rate Modal -->
<div class="modal fade" id="editTaxModal" tabindex="-1" aria-labelledby="editTaxModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaxModalLabel">Edit Tax Rate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTaxForm">
                    <input type="hidden" id="edit_tax_id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_cgst" class="form-label">CGST (%)</label>
                            <input type="number" step="0.01" class="form-control" id="edit_cgst" name="cgst" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_sgst" class="form-label">SGST (%)</label>
                            <input type="number" step="0.01" class="form-control" id="edit_sgst" name="sgst" required>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="edit_is_active" name="is_active">
                        <label class="form-check-label" for="edit_is_active">
                            Active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="updateTaxBtn">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Tax Confirmation Modal -->
<div class="modal fade" id="deleteTaxModal" tabindex="-1" aria-labelledby="deleteTaxModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTaxModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this tax rate? This action cannot be undone.</p>
                <p class="text-danger" id="tax-delete-warning" style="display: none;">Warning: This tax rate is currently used by one or more treatments. Deleting it will affect those treatments.</p>
                <input type="hidden" id="delete_tax_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteTaxBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- View Hospital Modal -->
<div class="modal fade" id="viewHospitalModal" tabindex="-1" aria-labelledby="viewHospitalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewHospitalModalLabel">Hospital Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Name:</strong> <span id="view_name"></span></p>
                <p><strong>Address:</strong> <span id="view_address"></span></p>
                <p><strong>Phone:</strong> <span id="view_phone"></span></p>
                <p><strong>Email:</strong> <span id="view_email"></span></p>
                <p><strong>Website:</strong> <a id="view_website" href="#" target="_blank"></a></p>
                <p><strong>Established:</strong> <span id="view_established_year"></span></p>
            </div>
            <div class="modal-footer">
                <button id="downloadPdfBtn" class="btn btn-success">
                    <i class="bi bi-download"></i> Download Visiting Card
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Hospital Modal -->
<div class="modal fade" id="editHospitalModal" tabindex="-1" aria-labelledby="editHospitalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editHospitalModalLabel">Edit Hospital</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editHospitalForm">
                    {% csrf_token %}
                    <input type="hidden" id="edit_hospital_id">
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Hospital Name</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_address" class="form-label">Address</label>
                        <textarea class="form-control" id="edit_address" name="address" rows="2" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="edit_phone" name="phone" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit_email" name="email" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_website" class="form-label">Website</label>
                            <input type="url" class="form-control" id="edit_website" name="website">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_established_year" class="form-label">Established Year</label>
                            <input type="number" class="form-control" id="edit_established_year" name="established_year">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="updateHospitalBtn">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Hospital Confirmation Modal -->
<div class="modal fade" id="deleteHospitalModal" tabindex="-1" aria-labelledby="deleteHospitalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteHospitalModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this hospital? This action cannot be undone.</p>
                <input type="hidden" id="delete_hospital_id">
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteHospitalBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    $(document).ready(function() {
    // Function to show notification
    function showNotification(message, type = 'success') {
        // Create notification element
        const notification = $(`<div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`);
        
        // Prepend to container
        $('.container').prepend(notification);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            notification.alert('close');
        }, 5000);
    }
    
    // Function to load tax rates
    function loadTaxRates(selectElement, selectedRate = null) {
        $.ajax({
            type: 'GET',
            url: "{% url 'tax-rate-list-create' %}",
            success: function(response) {
                const taxRates = response.tax_rates || response;
                $(selectElement).empty();
                
                taxRates.forEach(function(rate) {
                    const option = $('<option></option>')
                        .attr('value', rate.id)
                        .text(`CGST: ${rate.cgst}% + SGST: ${rate.sgst}% (Total: ${parseFloat(rate.cgst) + parseFloat(rate.sgst)}%)`);
                        
                    if (selectedRate && rate.id == selectedRate) {
                        option.attr('selected', 'selected');
                    }
                    
                    $(selectElement).append(option);
                });
            },
            error: function(error) {
                console.error('Error loading tax rates:', error);
                $(selectElement).html('<option value="">Failed to load tax rates</option>');
                showNotification('Failed to load tax rates', 'danger');
            }
        });
    }

    // ================= TREATMENT PRICE MANAGEMENT =================
    
    // Add new treatment price
    $('#treatmentPriceForm').on('submit', function(e) {
        e.preventDefault();
        const formData = $(this).serialize();
        
        $.ajax({
            type: 'POST',
            url: "{% url 'treatment-price-list-create' %}",
            data: formData,
            success: function(response) {
                showNotification('Treatment price added successfully!');
                location.reload();
            },
            error: function(error) {
                console.error('Error:', error);
                showNotification('Error adding treatment price. Please check the form.', 'danger');
            }
        });
    });
    
    // Edit treatment price
    $('.edit-treatment-btn').on('click', function() {
        const treatmentId = $(this).data('id');
        
        // First, load the tax rates
        loadTaxRates('#edit_tax_rate');
        
        // Then load the treatment details
        $.ajax({
            type: 'GET',
            url: "{% url 'treatment-price-detail' pk=0 %}".replace('0', treatmentId),
            success: function(response) {
                const treatment = response.treatment || response;
                $('#edit_treatment_id').val(treatment.id);
                $('#edit_treatment_name').val(treatment.treatment_name);
                $('#edit_base_price').val(treatment.base_price);
                
                // Reload tax rates with the selected one
                loadTaxRates('#edit_tax_rate', treatment.tax_rate);
                
                $('#editTreatmentModal').modal('show');
            },
            error: function(error) {
                console.error('Error:', error);
                showNotification('Error loading treatment details.', 'danger');
            }
        });
    });
    
    // Update treatment price
    $('#updateTreatmentBtn').on('click', function() {
        const treatmentId = $('#edit_treatment_id').val();
        const formData = $('#editTreatmentForm').serialize();
        
        $.ajax({
            type: 'PUT',
            url: "{% url 'treatment-price-detail' pk=0 %}".replace('0', treatmentId),
            data: formData,
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function(response) {
                $('#editTreatmentModal').modal('hide');
                showNotification('Treatment price updated successfully!');
                location.reload();
            },
            error: function(error) {
                console.error('Error:', error);
                showNotification('Error updating treatment price. Please check the form.', 'danger');
            }
        });
    });
    
    // Delete treatment price (show confirmation)
    $('.delete-treatment-btn').on('click', function() {
        const treatmentId = $(this).data('id');
        $('#delete_treatment_id').val(treatmentId);
        $('#deleteTreatmentModal').modal('show');
    });
    
    // Confirm delete treatment
    $('#confirmDeleteTreatmentBtn').on('click', function() {
        const treatmentId = $('#delete_treatment_id').val();
        
        $.ajax({
            type: 'DELETE',
            url: "{% url 'treatment-price-detail' pk=0 %}".replace('0', treatmentId),
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function() {
                $('#deleteTreatmentModal').modal('hide');
                showNotification('Treatment price deleted successfully!');
                location.reload();
            },
            error: function(error) {
                console.error('Error:', error);
                showNotification('Error deleting treatment price.', 'danger');
            }
        });
    });
    
    // ================= TAX RATE MANAGEMENT =================
    
    // Add new tax rate
    $('#taxRateForm').on('submit', function(e) {
        e.preventDefault();
        
        // Get the current date in YYYY-MM-DD format
        const currentDate = new Date().toISOString().split('T')[0];

        // Serialize form data
        let formData = $(this).serialize();

        // Append effective_date to form data
        formData += `&effective_date=${currentDate}`;
        
        $.ajax({
            type: 'POST',
            url: "{% url 'tax-rate-list-create' %}",
            data: formData,
            success: function(response) {
                showNotification('Tax rate added successfully!');
                location.reload();
            },
            error: function(error) {
                console.error('Error:', error);
                showNotification('Error adding tax rate. Please check the form.', 'danger');
            }
        });
    });

    // Edit tax rate - show form
    $('.edit-tax-btn').on('click', function() {
        const taxId = $(this).data('id');

        $.ajax({
            type: 'GET',
            url: "{% url 'tax-rate-detail' pk=0 %}".replace('0', taxId),
            success: function(response) {
                const tax = response.tax_rate || response;
                
                // Populate modal fields with response data
                $('#edit_tax_id').val(tax.id);
                $('#edit_cgst').val(tax.cgst);
                $('#edit_sgst').val(tax.sgst);
                $('#edit_is_active').prop('checked', tax.is_active);

                // Show the modal
                $('#editTaxModal').modal('show');
            },
            error: function(error) {
                console.error('Error:', error);
                alert('Error loading tax rate details.');
            }
        });
    });

    // Update tax rate
    $('#updateTaxBtn').on('click', function() {
        const taxId = $('#edit_tax_id').val();
        const formData = $('#editTaxForm').serializeArray(); // Use serializeArray for better manipulation
        
        // Get current date in YYYY-MM-DD format
        const currentDate = new Date().toISOString().split('T')[0];
        
        // Add effective_date manually
        formData.push({ name: 'effective_date', value: currentDate });

        // Add `_method=PUT` since jQuery AJAX doesn't support PUT properly with form data
        formData.push({ name: '_method', value: 'PUT' });

        $.ajax({
            type: 'PUT', // Django handles updates via POST with _method=PUT
            url: "{% url 'tax-rate-detail' pk=0 %}".replace('0', taxId),
            data: $.param(formData), // Convert array back to URL-encoded string
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function(response) {
                $('#editTaxModal').modal('hide');
                alert('Tax rate updated successfully!');
                location.reload();
            },
            error: function(error) {
                console.error('Error:', error);
                alert('Error updating tax rate. Please check the form.');
            }
        });
    });
        
    // Delete tax rate (show confirmation)
    $('.delete-tax-btn').on('click', function() {
        const taxId = $(this).data('id');
        $('#delete_tax_id').val(taxId);
        
        // Check if this tax rate is used by any treatments
        $.ajax({
            type: 'GET',
            url: "{% url 'treatment-price-list-create' %}",
            success: function(response) {
                const treatments = response.treatments || response;
                const isUsed = treatments.some(treatment => treatment.tax_rate == taxId);
                
                if (isUsed) {
                    $('#tax-delete-warning').show();
                } else {
                    $('#tax-delete-warning').hide();
                }
                
                $('#deleteTaxModal').modal('show');
            },
            error: function(error) {
                console.error('Error checking tax usage:', error);
                $('#tax-delete-warning').hide();
                $('#deleteTaxModal').modal('show');
            }
        });
    });
    
    // Confirm delete tax
    $('#confirmDeleteTaxBtn').on('click', function() {
        const taxId = $('#delete_tax_id').val();
        
        $.ajax({
            type: 'DELETE',
            url: "{% url 'tax-rate-detail' pk=0 %}".replace('0', taxId),
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function() {
                $('#deleteTaxModal').modal('hide');
                alert('Tax rate deleted successfully!');
                location.reload();
            },
            error: function(error) {
                console.error('Error:', error);
                alert('Error deleting tax rate. It may be in use by treatments.');
            }
        });
    });

    // View hospital details
    $('.view-hospital-btn').on('click', function() {
        const hospitalId = $(this).data('id');
        
        $.ajax({
            type: 'GET',
            url: "/superadmin/hospital-info/" + hospitalId + "/",
            headers: {
                "Content-Type": "application/json"
            },
            success: function(response) {
                const hospital = response.hospital || response;
                $('#view_name').text(hospital.name);
                $('#view_address').text(hospital.address);
                $('#view_phone').text(hospital.phone);
                $('#view_email').text(hospital.email);
                $('#view_website').text(hospital.website).attr('href', hospital.website);
                $('#view_established_year').text(hospital.established_year);
                
                $('#viewHospitalModal').modal('show');
            },
            error: function(error) {
                console.error('Error:', error);
                alert('Error loading hospital details.');
            }
        });
    });

    // Edit hospital
    $('.edit-hospital-btn').on('click', function() {
        const hospitalId = $(this).data('id');
        
        $.ajax({
            type: 'GET',
            url: "/superadmin/hospital-info/" + hospitalId + "/",
            success: function(response) {
                const hospital = response.hospital || response;
                $('#edit_hospital_id').val(hospital.id);
                $('#edit_name').val(hospital.name);
                $('#edit_address').val(hospital.address);
                $('#edit_phone').val(hospital.phone);
                $('#edit_email').val(hospital.email);
                $('#edit_website').val(hospital.website);
                $('#edit_established_year').val(hospital.established_year);
                
                $('#editHospitalModal').modal('show');
            },
            error: function(error) {
                console.error('Error:', error);
                alert('Error loading hospital details.');
            }
        });
    });

    // Update hospital
    $('#updateHospitalBtn').on('click', function() {
        const hospitalId = $('#edit_hospital_id').val();
        const formData = $('#editHospitalForm').serialize();
        
        $.ajax({
            type: 'PUT',
            url: "/superadmin/hospital-info/" + hospitalId + "/",
            data: formData,
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function(response) {
                $('#editHospitalModal').modal('hide');
                showNotification('Hospital updated successfully!');
                location.reload();
            },
            error: function(error) {
                console.error('Error:', error);
                showNotification('Error updating hospital. Please check the form.', 'danger');
            }
        });
    });

    // Delete hospital (show confirmation)
    $('.delete-hospital-btn').on('click', function() {
        const hospitalId = $(this).data('id');
        $('#delete_hospital_id').val(hospitalId);
        $('#deleteHospitalModal').modal('show');
    });

    // Confirm delete hospital
    $('#confirmDeleteHospitalBtn').on('click', function() {
        const hospitalId = $('#delete_hospital_id').val();
        
        $.ajax({
            type: 'DELETE',
            url: "/superadmin/hospital-info/" + hospitalId + "/",
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function() {
                $('#deleteHospitalModal').modal('hide');
                showNotification('Hospital deleted successfully!');
                location.reload();
            },
            error: function(error) {
                console.error('Error:', error);
                showNotification('Error deleting hospital.', 'danger');
            }
        });
    });

    // Add the PDF generation functionality
    $('#downloadPdfBtn').on('click', function() {
        const { jsPDF } = window.jspdf;
        
        // Create new PDF document (business card size)
        const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: [90, 50] // Standard business card size
        });
        
        // Get hospital data
        const hospitalName = $('#view_name').text();
        const hospitalAddress = $('#view_address').text();
        const hospitalPhone = $('#view_phone').text();
        const hospitalEmail = $('#view_email').text();
        const hospitalWebsite = $('#view_website').text();
        
        // Set background color (light blue)
        doc.setFillColor(230, 240, 255);
        doc.rect(0, 0, 90, 50, 'F');
        
        // Add border
        doc.setDrawColor(70, 130, 180);
        doc.setLineWidth(0.5);
        doc.rect(2, 2, 86, 46);
        
        // Add hospital name
        doc.setFontSize(14);
        doc.setTextColor(40, 40, 120);
        doc.setFont('helvetica', 'bold');
        doc.text(hospitalName, 45, 10, { align: 'center' });
        
        // Add separator line
        doc.setDrawColor(70, 130, 180);
        doc.line(10, 14, 80, 14);
        
        // Add contact details
        doc.setFontSize(8);
        doc.setTextColor(60, 60, 60);
        doc.setFont('helvetica', 'normal');
        
        // Calculate text positions
        let yPos = 20;
        const lineHeight = 5;
        
        // Address with icon
        doc.text('üè¢ ' + hospitalAddress, 6, yPos);
        yPos += lineHeight;
        
        // Phone with icon
        doc.text('üìû ' + hospitalPhone, 6, yPos);
        yPos += lineHeight;
        
        // Email with icon
        doc.text('‚úâÔ∏è ' + hospitalEmail, 6, yPos);
        yPos += lineHeight;
        
        // Website with icon
        if (hospitalWebsite) {
            doc.text('üåê ' + hospitalWebsite, 6, yPos);
            yPos += lineHeight;
        }
        
        // Add a footer note
        doc.setFontSize(6);
        doc.setTextColor(100, 100, 100);
        doc.text('Generated on ' + new Date().toLocaleDateString(), 45, 45, { align: 'center' });
        
        // Save the PDF with the hospital name
        doc.save(hospitalName.replace(/\s+/g, '_') + '_contact.pdf');
    });
});
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
{% endblock %}
{% endblock %}